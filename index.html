<!DOCTYPE html>

<html>

  <head>

    <meta charset="UTF-8" />

    <title>çœŸå¯¦æ©¢åœ“è»Œé“å‹•ç•«ï¼ˆæ™‚é–“å€ç‡å¯èª¿ï¼‰</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

  </head>

  <body>

    <script>

      let semiMajorAxisSlider, eccentricitySlider, timeScaleSlider;

      let valueA, valueE, timeScaleValue;

      let labelA, labelE, labelT;

      let resetButton;


      let angle = 0;

      let G = 1, M = 1;

      let energyData = [];

      let maxSteps = 20000;

      let recording = true;

      let trail = [];


      function setup() {

        createCanvas(1000, 600);

        angleMode(RADIANS);


        // --- åŠå¾‘ a ---

        labelA = createP("ğŸ”µ åŠå¾‘ aï¼ˆé•·åŠè»¸ï¼‰");

        labelA.position(20, height + 0);


        semiMajorAxisSlider = createSlider(50, 300, 200);

        semiMajorAxisSlider.position(20, height + 30);

        semiMajorAxisSlider.style('width', '200px');


        valueA = createSpan();

        valueA.position(230, height + 30);


        // --- é›¢å¿ƒç‡ e ---

        labelE = createP("ğŸŸ  é›¢å¿ƒç‡ eï¼ˆæ©¢åœ“ç¨‹åº¦ï¼‰");

        labelE.position(20, height + 60);


        eccentricitySlider = createSlider(0, 0.95, 0.6, 0.01);

        eccentricitySlider.position(20, height + 90);

        eccentricitySlider.style('width', '200px');


        valueE = createSpan();

        valueE.position(230, height + 90);


        // --- é‡ç½®æŒ‰éˆ• ---

        resetButton = createButton("ğŸ” é‡ç½®æ¨¡æ“¬");

        resetButton.position(20, height + 140);

        resetButton.mousePressed(resetSimulation);


        // --- æ™‚é–“å€ç‡ Time Scale ---

        labelT = createP("â±ï¸ æ™‚é–“å€ç‡ï¼ˆé€Ÿåº¦èª¿æ•´ï¼‰");

        labelT.position(20, height + 180);


        timeScaleSlider = createSlider(10, 50, 10, 1); // ä¿®æ”¹ç‚º10~50

        timeScaleSlider.position(20, height + 210);

        timeScaleSlider.style('width', '200px');


        timeScaleValue = createSpan();

        timeScaleValue.position(230, height + 210);

      }


      function draw() {

        background(10);


        // è®€å–ä½¿ç”¨è€…åƒæ•¸

        let a = semiMajorAxisSlider.value();

        let e = eccentricitySlider.value();

        let timeScale = timeScaleSlider.value();

        let b = a * sqrt(1 - e * e);


        // æ›´æ–°æ–‡å­—

        valueA.html(`${a} px`);

        valueE.html(`${nf(e, 1, 2)}`);

        timeScaleValue.html(`${nf(timeScale, 1, 1)}x`);


        // === è»Œé“èˆ‡è¡Œæ˜Ÿ ===

        push();

        translate(width / 2, height / 2); // å¤ªé™½åœ¨ç•«å¸ƒä¸­å¤®ï¼ˆå·¦ç„¦é»ï¼‰


        let r = (a * (1 - e * e)) / (1 + e * cos(angle));

        let x = r * cos(angle);

        let y = r * sin(angle);


        // è¨˜éŒ„è»Œè·¡

        trail.push({ x, y });

        if (trail.length > maxSteps) trail.shift();


        // --- åƒè€ƒæ©¢åœ“è¼ªå»“ ---

        noFill();

        stroke(100, 100, 100, 80);

        ellipse(-a * e, 0, 2 * a, 2 * b);


        // --- è¡Œæ˜Ÿè»Œè·¡ç·š ---

        noFill();

        stroke(0, 150, 255);

        beginShape();

        for (let p of trail) vertex(p.x, p.y);

        endShape();


        // --- å¤ªé™½ ---

        noStroke();

        fill(255, 204, 0);

        ellipse(0, 0, 30, 30);


        // --- è¡Œæ˜Ÿ ---

        fill(100, 200, 255);

        ellipse(x, y, 16, 16);


        // --- é€Ÿåº¦å‘é‡ ---

        stroke(255, 0, 0);

        let tangentX = -sin(angle);

        let tangentY = cos(angle);

        let v = sqrt(G * M * (2 / r - 1 / a));

        let mag = v * 10; // æ”¾å¤§å€ç‡

        line(x, y, x + tangentX * mag, y + tangentY * mag);

        pop();


        // === èƒ½é‡è¨ˆç®— ===

        let KE = 0.5 * v * v;

        let PE = -G * M / r;

        let E = KE + PE;


        if (recording && energyData.length < maxSteps) {

          energyData.push({ KE, PE, E });

        } else if (energyData.length >= maxSteps) {

          recording = false;

        }


        drawEnergyGraph();


        // âœ… æ ¹æ“šè§’å‹•é‡æ”¹è®Šè§’åº¦

        let h = sqrt(G * M * a * (1 - e * e));

        let dTheta = h / (r * r);

        angle += dTheta * timeScale;

      }


      function drawEnergyGraph() {

        push();

        translate(width * 0.55, 50);

        let graphW = 400;

        let graphH = 200;


        // èƒŒæ™¯

        noStroke();

        fill(20, 20, 30, 180);

        rect(0, 0, graphW, graphH, 8);


        // è™›ç·šèƒŒæ™¯ç·š

        stroke(120);

        strokeWeight(0.5);

        for (let y = 0; y <= graphH; y += 40) {

          drawingContext.setLineDash([5, 5]);

          line(0, y, graphW, y);

        }

        drawingContext.setLineDash([]);


        // æ¨™é¡Œèˆ‡è»¸

        noStroke();

        fill(255);

        textSize(12);

        text("èƒ½é‡åœ–ï¼ˆå–®ä½ï¼šç„¦è€³ï¼‰", 10, -10);

        text("æ™‚é–“ï¼ˆframeï¼‰", graphW / 2 - 30, graphH + 20);


        // èƒ½é‡ç¯„åœ

        let minY = Infinity;

        let maxY = -Infinity;

        for (let d of energyData) {

          minY = min(minY, d.PE);

          maxY = max(maxY, d.KE);

        }


        // åŠ ä¸Š y = 0 è™›ç·š

        if (minY < 0 && maxY > 0) {

          let zeroY = map(0, minY, maxY, graphH, 0);

          stroke(200);

          strokeWeight(1);

          drawingContext.setLineDash([3, 3]);

          line(0, zeroY, graphW, zeroY);

          drawingContext.setLineDash([]);


          noStroke();

          fill(200);

          textAlign(RIGHT);

          text("0", -5, zeroY + 4);

        }


        // æ•¸å€¼æ¨™ç¤º

        fill(150);

        noStroke();

        textAlign(RIGHT);

        text(nf(maxY, 1, 2), -5, 10);

        text(nf(minY, 1, 2), -5, graphH - 2);


        // ç•«èƒ½é‡æ›²ç·š

        drawEnergyLineSmooth(energyData, "KE", color(0, 150, 255), minY, maxY, graphW, graphH);

        drawEnergyLineSmooth(energyData, "PE", color(255, 100, 100), minY, maxY, graphW, graphH);

        drawEnergyLineSmooth(energyData, "E", color(180, 100, 255), minY, maxY, graphW, graphH);


        // åœ–ä¾‹

        let legendX = graphW + 30;

        let legendY = 10;

        textSize(12);

        textAlign(LEFT);

        drawLegendItem(legendX, legendY, color(0, 150, 255), "å‹•èƒ½ KEï¼ˆè—ï¼‰");

        drawLegendItem(legendX, legendY + 20, color(255, 100, 100), "ä½èƒ½ PEï¼ˆç´…ï¼‰");

        drawLegendItem(legendX, legendY + 40, color(180, 100, 255), "ç¸½èƒ½é‡ Eï¼ˆç´«ï¼‰");


        pop();

      }


      function drawEnergyLineSmooth(data, key, col, minY, maxY, w, h) {

        noFill();

        stroke(col);

        strokeWeight(1.5);

        beginShape();

        for (let i = 0; i < data.length; i++) {

          let x = map(i, 0, data.length - 1, 0, w);

          let y = map(data[i][key], minY, maxY, h, 0);

          curveVertex(x, y);

        }

        endShape();

      }


      function drawLegendItem(x, y, col, label) {

        fill(col);

        noStroke();

        rect(x, y, 12, 12);

        fill(255);

        noStroke();

        text(label, x + 18, y + 10);

      }


      function resetSimulation() {

        energyData = [];

        trail = [];

        angle = 0;

        recording = true;

      }

    </script>

  </body>

</html>
